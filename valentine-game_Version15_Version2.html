<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Sweet Pixel Stack - 99 Mission</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
            outline: none !important;
            -webkit-user-select: none;
            user-select: none;
        }

        html,
        body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            position: fixed;
            overscroll-behavior: none;
            background: linear-gradient(135deg, #ffd1dc 0%, #fecfef 100%);
            font-family: 'Press Start 2P', cursive;
            touch-action: none;
            color: #ff758c;
            -webkit-touch-callout: none;
        }

        body::after {
            content: " ";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(rgba(255, 255, 255, 0) 50%, rgba(255, 182, 193, 0.1) 50%);
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 30000;
        }

        #gameWrapper {
            position: absolute;
            top: 8px;
            left: 8px;
            right: 8px;
            bottom: 8px;
            overflow: hidden;
            pointer-events: none;
            z-index: 1;
            border: 4px solid #fff;
            background: rgba(255, 255, 255, 0.3);
            box-shadow: inset 0 0 50px rgba(255, 255, 255, 0.5);
        }

        #gameArea {
            position: relative;
            width: 100%;
            height: 100%;
            pointer-events: auto;
        }

        .hud {
            position: fixed;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            background: rgba(255, 255, 255, 0.9);
            padding: 12px 0;
            border: 3px solid #ff758c;
            box-shadow: 4px 4px 0 #fff;
            z-index: 9999;
            opacity: 0;
            width: calc(100% - 40px);
            max-width: 500px;
        }

        .stat-item {
            text-align: center;
            flex: 1;
            border-right: 2px solid #ffd1dc;
        }

        .stat-item:last-child {
            border-right: none;
        }

        .stat-label {
            font-size: 7px;
            color: #ff758c;
            margin-bottom: 6px;
        }

        .stat-value {
            font-size: 10px;
            color: #ff4757;
        }

        .heart-wrapper {
            position: absolute;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            z-index: 10;
        }

        .heart-visual span {
            font-size: 35px;
            filter: drop-shadow(2px 2px 0 #fff);
        }

        .heart-visual img {
            width: 52px;
            height: 52px;
            border: 3px solid #fff;
            border-radius: 8px;
            image-rendering: pixelated;
        }

        .floating-score {
            position: fixed;
            pointer-events: none;
            font-size: 14px;
            z-index: 10000;
            text-shadow: 2px 2px 0 #fff;
            animation: score-up 0.6s ease-out forwards;
        }

        @keyframes score-up {
            0% {
                transform: translateY(0);
                opacity: 1;
            }

            100% {
                transform: translateY(-70px);
                opacity: 0;
            }
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 240, 245, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 20000;
            backdrop-filter: blur(4px);
        }

        .content-box {
            background: #fff;
            padding: 25px;
            border: 4px solid #ff758c;
            text-align: center;
            width: calc(100% - 60px);
            max-width: 350px;
            box-shadow: 8px 8px 0 #ffd1dc;
        }

        .button {
            background: #ff758c;
            color: #fff;
            border: 4px solid #fff;
            padding: 15px;
            font-size: 10px;
            font-family: 'Press Start 2P', cursive;
            cursor: pointer;
            width: 100%;
            box-shadow: 4px 4px 0 #ffd1dc;
            margin-top: 15px;
        }

        .button.secondary {
            background: #444;
            color: #eee;
            border: 4px solid #888;
            box-shadow: 4px 4px 0 #222;
        }

        #prizeDisplay {
            font-size: 28px;
            color: #ff4757;
            margin: 15px 0;
            text-shadow: 2px 2px 0 #ffd1dc;
        }

        .bomb-flash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #fff;
            opacity: 0;
            pointer-events: none;
            z-index: 1500;
        }

        @keyframes flash-sweet {
            0% {
                opacity: 0.5;
            }

            100% {
                opacity: 0;
            }
        }

        .big-black-heart {
            display: block;
            width: 100px;
            height: 100px;
            margin: 10px auto;
            border: 4px solid #444;
            border-radius: 12px;
            image-rendering: pixelated;
            filter: grayscale(100%) drop-shadow(4px 4px 0px #000);
            animation: heart-shake 0.5s infinite;
            object-fit: cover;
        }

        @keyframes heart-shake {
            0% {
                transform: rotate(0deg);
            }

            25% {
                transform: rotate(5deg);
            }

            75% {
                transform: rotate(-5deg);
            }

            100% {
                transform: rotate(0deg);
            }
        }
    </style>
</head>

<body>

    <div class="bomb-flash" id="flash"></div>

    <div class="hud" id="hud">
        <div class="stat-item">
            <div class="stat-label">GOAL</div>
            <div class="stat-value" id="targetCount">99</div>
        </div>
        <div class="stat-item">
            <div class="stat-label">SCORE</div>
            <div class="stat-value" id="score">0</div>
        </div>
        <div class="stat-item">
            <div class="stat-label">LOAD</div>
            <div class="stat-value" id="loadPercent">0%</div>
        </div>
        <div class="stat-item">
            <div class="stat-label">SPD</div>
            <div class="stat-value" id="speedLevel">1.0</div>
        </div>
    </div>

    <div id="gameWrapper">
        <div id="gameArea"></div>
    </div>

    <div class="overlay" id="guideOverlay">
        <div class="content-box">
            <h2 style="font-size: 11px; color: #ff758c; margin-bottom: 20px;">SWEET PIXEL MISSION</h2>
            <p style="font-size: 9px; color: #ff758c; line-height: 2.5;">üíñ +1 | üë©‚Äçü¶≥ +2 | üë®‚Äçü¶≤ ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢+2 (30%)</p>
            <button class="button" id="entryBtn" onclick="prepareStart()" disabled>PREPARING...</button>
        </div>
    </div>

    <div class="overlay" id="endModal" style="display: none;">
        <div class="content-box">
            <h2 id="endTitle" style="color: #ff758c; font-size: 14px; margin-bottom: 10px;"></h2>

            <div id="loseArea" style="display:none;">
                <img src="https://i.ibb.co/1yqN4Px/test-photo-face.jpg" class="big-black-heart" alt="Game Over">
                <p style="font-size: 12px; color: #444; margin: 15px 0;">‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏∞‡∏ô‡πä‡∏≠‡∏ô‡∏ô‡∏ô!</p>
            </div>

            <div id="rouletteArea" style="display:none; margin: 10px 0; border: 2px dashed #ff758c; padding: 15px;">
                <p style="font-size: 8px; color: #ff758c;">‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà‡∏õ‡∏≠‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö:</p>
                <div id="prizeDisplay">0</div>
                <p style="font-size: 10px; color: #ff758c;">BAHT</p>
            </div>

            <p id="finalTimeText" style="margin: 10px 0; font-size: 8px; line-height: 1.5; color: #ff758c;"></p>

            <button id="btnWin" class="button" onclick="handleCall()" style="display:none;">GET PRIZE & CALL</button>
            <button id="btnLose" class="button secondary" onclick="handleRetry()" style="display:none;">TRY
                AGAIN</button>
        </div>
    </div>

    <button class="button" id="startBtn"
        style="display:none; position:fixed; z-index:20001; width:auto; padding: 10px 25px;" onclick="startGame()">PUSH
        START</button>

    <script>
        const IMAGES_URLS = { green: 'https://i.ibb.co/mCyhs8vW/bonus-photo.jpg', black: 'https://i.ibb.co/1yqN4Px/test-photo-face.jpg' };
        const imageCache = {};
        let state = { score: 0, target: 99, running: false, speed: 1.0, lastSpawn: 0, hearts: [], startTime: 0 };

        async function preloadAssets() {
            try {
                for (let key in IMAGES_URLS) {
                    const img = new Image();
                    img.src = IMAGES_URLS[key];
                    await img.decode();
                    imageCache[key] = img;
                }
                document.getElementById('entryBtn').textContent = "START CANDY";
                document.getElementById('entryBtn').disabled = false;
            } catch (e) { console.error(e); }
        }

        function prepareStart() {
            document.getElementById('guideOverlay').style.display = 'none';
            const btn = document.getElementById('startBtn');
            btn.style.display = 'block';
            btn.style.left = '50%'; btn.style.top = '50%'; btn.style.transform = 'translate(-50%, -50%)';
        }

        function startGame() {
            state = { score: 0, target: 99, running: true, speed: 1.0, lastSpawn: 0, hearts: [], startTime: Date.now() };
            document.getElementById('gameArea').innerHTML = '';
            document.getElementById('endModal').style.display = 'none';
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('hud').style.opacity = '1';
            updateUI();
            requestAnimationFrame(gameLoop);
        }

        function gameLoop() {
            if (!state.running) return;
            const now = Date.now();
            state.speed = 1.0 + (now - state.startTime) / 30000;
            document.getElementById('speedLevel').textContent = state.speed.toFixed(1);
            if (now - state.lastSpawn > (1400 / state.speed)) { spawnHeart(); state.lastSpawn = now; }
            updateHearts();
            checkGameState();
            requestAnimationFrame(gameLoop);
        }

        function spawnHeart() {
            const area = document.getElementById('gameArea');
            const wrapper = document.createElement('div');
            const rand = Math.random() * 100;
            let type = (rand > 97) ? 'bomb' : (rand > 85) ? 'green' : (rand > 55) ? 'black' : 'pink';

            wrapper.className = `heart-wrapper ${type}`;
            const x = Math.random() * (area.offsetWidth - 50);
            wrapper.style.left = x + 'px';
            wrapper.style.top = area.offsetHeight + 'px';

            const visual = document.createElement('div');
            visual.className = 'heart-visual';
            if (type === 'pink') visual.innerHTML = '<span>üíñ</span>';
            else if (type === 'bomb') visual.innerHTML = '<span>üí£</span>';
            else visual.appendChild(imageCache[type].cloneNode());

            wrapper.appendChild(visual);
            area.appendChild(wrapper);

            const heartObj = { el: wrapper, type: type, x: x, y: area.offsetHeight, status: 'moving' };
            wrapper.onclick = (e) => {
                e.preventDefault();
                if (type === 'bomb') triggerBomb();
                else if (type === 'black') { state.target += 2; showFloatingScore(e.clientX, e.clientY, "GOAL+2", "#888"); removeHeart(heartObj); }
                else {
                    const pts = (type === 'green' ? 2 : 1);
                    state.score += pts;
                    showFloatingScore(e.clientX, e.clientY, `+${pts}`, (type === 'green' ? "#00c853" : "#ff4757"));
                    removeHeart(heartObj);
                }
                updateUI();
                playSound(type === 'bomb' ? 'bomb' : 'pop');
            };
            state.hearts.push(heartObj);
        }

        function updateHearts() {
            const area = document.getElementById('gameArea');
            const stackedHearts = state.hearts.filter(h => h.status === 'stacked');
            state.hearts.forEach(h => {
                let upperLimitY = 0;
                stackedHearts.forEach(sh => {
                    if (sh !== h && sh.y < h.y && Math.abs(h.x - sh.x) < 45) upperLimitY = Math.max(upperLimitY, sh.y + 50);
                });
                if (h.y > upperLimitY) { h.status = 'moving'; h.y -= (2.5 * state.speed); if (h.y < upperLimitY) h.y = upperLimitY; }
                else { h.y = upperLimitY; h.status = 'stacked'; }
                h.el.style.transform = `translateY(${h.y - area.offsetHeight}px)`;
            });
        }

        function removeHeart(h) { h.el.remove(); state.hearts = state.hearts.filter(x => x !== h); }
        function showFloatingScore(x, y, text, color) {
            const el = document.createElement('div'); el.className = 'floating-score'; el.textContent = text;
            el.style.left = x + 'px'; el.style.top = y + 'px'; el.style.color = color;
            document.body.appendChild(el); setTimeout(() => el.remove(), 600);
        }

        function triggerBomb() {
            const flash = document.getElementById('flash');
            flash.style.animation = 'none'; void flash.offsetWidth; flash.style.animation = 'flash-sweet 0.6s ease-out';
            state.hearts.filter(h => h.type !== 'black').forEach(h => {
                if (h.type === 'pink') state.score += 1; if (h.type === 'green') state.score += 2;
                h.el.remove();
            });
            state.hearts = state.hearts.filter(h => h.type === 'black');
            updateUI();
        }

        function checkGameState() {
            if (state.score >= state.target) { endGame("SWEET CLEAR!"); return; }
            const area = document.getElementById('gameArea');
            let lowestY = 0;
            state.hearts.forEach(h => { if (h.status === 'stacked') lowestY = Math.max(lowestY, h.y); });
            const load = Math.min(100, (lowestY / area.offsetHeight) * 100);
            document.getElementById('loadPercent').textContent = Math.floor(load) + '%';
            if (lowestY > area.offsetHeight - 80 && state.hearts.some(h => h.status === 'stacked')) endGame("LOAD FULL");
        }

        function updateUI() { document.getElementById('score').textContent = state.score; document.getElementById('targetCount').textContent = state.target; }

        function runRoulette() {
            const prizeEl = document.getElementById('prizeDisplay');
            let currentDelay = 40;
            const maxDelay = 400;
            const totalSteps = 45;
            let step = 0;

            function tick() {
                // ‡∏™‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á 333 ‡∏ñ‡∏∂‡∏á 10000
                // ‡∏™‡∏π‡∏ï‡∏£: Math.floor(Math.random() * (10000 - 333 + 1)) + 333
                const randomVal = Math.floor(Math.random() * 9668) + 333;
                prizeEl.textContent = randomVal.toLocaleString();

                step++;

                if (step < totalSteps) {
                    currentDelay += (maxDelay - currentDelay) / (totalSteps - step);
                    setTimeout(tick, currentDelay);
                } else {
                    // ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ ‡∏™‡∏∏‡πà‡∏°‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á 333 - 10000 ‡πÄ‡∏ä‡πà‡∏ô‡∏Å‡∏±‡∏ô
                    const finalVal = Math.floor(Math.random() * 9668) + 333;
                    prizeEl.textContent = finalVal.toLocaleString();
                    prizeEl.style.textShadow = "0 0 15px #ff4757";
                }
            }
            tick();
        }

        function endGame(title) {
            state.running = false;
            const timeTaken = ((Date.now() - state.startTime) / 1000).toFixed(2);
            document.getElementById('hud').style.opacity = '0';
            document.getElementById('endModal').style.display = 'flex';
            document.getElementById('finalTimeText').innerHTML = `TIME: ${timeTaken}s | SCORE: ${state.score}`;

            if (title === "SWEET CLEAR!") {
                document.getElementById('endTitle').textContent = "SWEET CLEAR!";
                document.getElementById('endTitle').style.color = "#ff758c";
                document.getElementById('rouletteArea').style.display = 'block';
                document.getElementById('loseArea').style.display = 'none';
                document.getElementById('btnWin').style.display = 'block';
                document.getElementById('btnLose').style.display = 'none';
                runRoulette();
            } else {
                document.getElementById('endTitle').textContent = "GAME OVER";
                document.getElementById('endTitle').style.color = "#444";
                document.getElementById('rouletteArea').style.display = 'none';
                document.getElementById('loseArea').style.display = 'block';
                document.getElementById('btnWin').style.display = 'none';
                document.getElementById('btnLose').style.display = 'block';
            }
        }

        function handleCall() { window.location.href = "tel:0927093636"; }
        function handleRetry() { startGame(); }

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;
            if (type === 'pop') {
                osc.type = 'square'; osc.frequency.setValueAtTime(523.25, now);
                osc.frequency.exponentialRampToValueAtTime(1046.50, now + 0.1);
                gain.gain.setValueAtTime(0.05, now); gain.gain.linearRampToValueAtTime(0, now + 0.1);
            } else if (type === 'bomb') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(80, now);
                gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.5);
            }
            osc.start(); osc.stop(now + 0.5);
        }

        preloadAssets();
    </script>
</body>

</html>